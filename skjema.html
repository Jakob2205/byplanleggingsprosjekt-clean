<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ny Plan</title>
    <link rel="stylesheet" href="skjema.css">
</head>
<body>
    <div class="form-container">
        <h2>Ny Plan</h2>
        <div class="form-group">
            <label>Fylke:</label>
            <select id="fylke">
                <option>Velg fylke</option>
                <option>Oslo</option>
                <option>Viken</option>
            </select>
            <button>+</button>
        </div>
        <div class="form-group">
            <label>Kommune:</label>
            <select id="kommune">
                <option>Velg kommune</option>
                <option>Bergen</option>
                <option>Trondheim</option>
            </select>
            <button>+</button>
        </div>
        <div class="form-group">
            <label>Plantype:</label>
            <select id="plantype">
                <option>Velg plantype</option>
            </select>
            <button onclick="addPlantype()">+</button>
        </div>
        <div class="form-group">
            <label>Plannavn:</label>
            <input type="text" id="plannavn" placeholder="Skriv inn plannavn">
        </div>
        <div class="form-group">
            <label>PlanID:</label>
            <input type="text" id="planid" readonly>
        </div>
        <div class="form-group">
            <label>Primært formål:</label>
            <select id="primaryPurpose">
                <option>Velg Formål</option>
                <option>Bolig</option>
                <option>Kommersiell</option>
            </select>
            <button>+</button>
        </div>
        <div class="form-group">
            <label>Sekundært formål:</label>
            <select id="secondaryPurpose">
                <option>Ikke aktuelt</option>
                <option>Rekreasjon</option>
                <option>Industri</option>
            </select>
            <button>+</button>
        </div>

        <div class="button-group">
            <button onclick="cancelForm()">Avbryt</button>
            <button onclick="submitForm()">Fullfør</button>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            loadPlantypes();
        });

        function loadPlantypes() {
            const plantypeDropdown = document.getElementById('plantype');
            const plantypes = ["Residential", "Commercial", "Industrial"]; // Example
            plantypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                plantypeDropdown.appendChild(option);
            });
        }

        function generateUniqueId() {
            return 'plan-' + Math.random().toString(36).substr(2, 9);
        }

        function submitForm() {
            const formData = {
                adminId: auth.currentUser ? auth.currentUser.uid : 'anonymous',
                fylke: document.getElementById('fylke').value,
                kommune: document.getElementById('kommune').value,
                plantype: document.getElementById('plantype').value,
                planNavn: document.getElementById('plannavn').value,
                planId: generateUniqueId(),
                primaryPurpose: document.getElementById('primaryPurpose').value,
                secondaryPurpose: document.getElementById('secondaryPurpose').value,
                timestamp: new Date()
            };

            setDoc(doc(db, "forms", formData.planId), formData)
                .then(() => alert("Planen ble lagret!"))
                .catch(error => console.error("Feil ved lagring:", error));

            console.log(formData);
        }

        // ✅ Make cancelForm globally accessible
        window.cancelForm = function() {
            if (window.parent && typeof window.parent.closeModal === 'function') {
                window.parent.closeModal(); // This triggers the closeModal function in Forside.html
            } else {
                console.warn("closeModal function not found in parent.");
            }
        };

        function addPlantype() {
            const newType = prompt("Legg til ny plantype:");
            if (newType) {
                const option = document.createElement('option');
                option.value = newType;
                option.textContent = newType;
                document.getElementById('plantype').appendChild(option);
            }
        }
    </script>
</body>
</html>
